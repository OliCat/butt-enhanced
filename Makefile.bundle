# Makefile pour crÃ©er un bundle macOS de BUTT avec StereoTool SDK
# Utilisation: make -f Makefile.bundle bundle

# Configuration
APP_NAME = BUTT
VERSION = 1.45.0
BUNDLE_NAME = $(APP_NAME).app
DMG_NAME = BUTT-$(VERSION)-macOS-StereoTool

# RÃ©pertoires
BUILD_DIR = build
BUNDLE_DIR = $(BUILD_DIR)/$(BUNDLE_NAME)
CONTENTS_DIR = $(BUNDLE_DIR)/Contents
MACOS_DIR = $(CONTENTS_DIR)/MacOS
FRAMEWORKS_DIR = $(CONTENTS_DIR)/Frameworks
RESOURCES_DIR = $(CONTENTS_DIR)/Resources

# Cibles principales
.PHONY: all bundle clean dmg test install

all: bundle

# Compilation de BUTT
compile:
	@echo "ðŸ”¨ Compilation de BUTT..."
	$(MAKE) -C src clean
	$(MAKE) -C src
	@echo "âœ… Compilation terminÃ©e"

# CrÃ©ation du bundle complet
bundle: compile
	@echo "ðŸŽ¯ CrÃ©ation du bundle macOS..."
	chmod +x build_macos_bundle.sh
	./build_macos_bundle.sh
	@echo "âœ… Bundle crÃ©Ã© avec succÃ¨s!"

# Nettoyage
clean:
	@echo "ðŸ§¹ Nettoyage..."
	rm -rf $(BUILD_DIR)
	$(MAKE) -C src clean
	@echo "âœ… Nettoyage terminÃ©"

# CrÃ©ation du DMG seulement
dmg: bundle
	@echo "ðŸ’¿ CrÃ©ation du DMG..."
	rm -f $(BUILD_DIR)/$(DMG_NAME).dmg
	hdiutil create -srcfolder $(BUNDLE_DIR) -volname "$(DMG_NAME)" -format UDZO -imagekey zlib-level=9 $(BUILD_DIR)/$(DMG_NAME).dmg
	@echo "âœ… DMG crÃ©Ã©: $(BUILD_DIR)/$(DMG_NAME).dmg"

# Tests de fonctionnalitÃ©
test: bundle
	@echo "ðŸ§ª Tests du bundle..."
	@echo "VÃ©rification de la structure du bundle:"
	@ls -la $(BUNDLE_DIR)/
	@echo ""
	@echo "VÃ©rification des frameworks:"
	@ls -la $(FRAMEWORKS_DIR)/
	@echo ""
	@echo "VÃ©rification des dÃ©pendances de l'exÃ©cutable:"
	@otool -L $(MACOS_DIR)/$(APP_NAME) | grep -E "(\.dylib|\.framework)" | head -10
	@echo ""
	@echo "VÃ©rification des dÃ©pendances StereoTool:"
	@otool -L $(FRAMEWORKS_DIR)/libStereoTool64.dylib | grep -E "(\.dylib|\.framework)" | head -5
	@echo ""
	@echo "âœ… Tests terminÃ©s"

# Installation dans Applications (nÃ©cessite sudo)
install: bundle
	@echo "ðŸš€ Installation dans /Applications..."
	sudo rm -rf /Applications/$(BUNDLE_NAME)
	sudo cp -R $(BUNDLE_DIR) /Applications/
	@echo "âœ… Installation terminÃ©e"

# Aide
help:
	@echo "ðŸ“‹ Commandes disponibles:"
	@echo "  make -f Makefile.bundle compile   - Compile BUTT"
	@echo "  make -f Makefile.bundle bundle    - CrÃ©e le bundle macOS complet"
	@echo "  make -f Makefile.bundle dmg       - CrÃ©e le bundle et gÃ©nÃ¨re un DMG"
	@echo "  make -f Makefile.bundle test      - Teste le bundle crÃ©Ã©"
	@echo "  make -f Makefile.bundle install   - Installe le bundle dans Applications"
	@echo "  make -f Makefile.bundle clean     - Nettoie les fichiers temporaires"
	@echo "  make -f Makefile.bundle help      - Affiche cette aide"
	@echo ""
	@echo "ðŸŽ¯ Commande recommandÃ©e: make -f Makefile.bundle dmg" 